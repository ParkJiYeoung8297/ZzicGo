# .github/workflows/fe_deploy.yml
name: Deploy Vite React App to EC2

on:
  push:
    branches:
      - develop
    paths:
      - "ZzicGo_fe/**"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node ì„¤ì¹˜
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.19.1

      # 3. ðŸ”¥ GitHub Secretsë¡œ .env.production ìƒì„±
    - name: Create .env
      run: |
        cd ZzicGo_fe

        # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ (ìžˆì–´ë„ ì—†ì–´ë„ OK)
        rm -f .env

        # ìƒˆë¡œ ìƒì„±
        echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" >> .env
        echo "VITE_NAVER_CLIENT_ID=${{ secrets.VITE_NAVER_CLIENT_ID }}" >> .env
        echo "VITE_NAVER_REDIRECT_URI=${{ secrets.VITE_NAVER_REDIRECT_URI }}" >> .env

        echo "âœ… .env created:"
        cat .env

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜ + ë¹Œë“œ
      - name: Install dependencies & Build
        run: |
          cd ZzicGo_fe
          npm ci
          npm run build

      # 5. EC2ë¡œ dist ì—…ë¡œë“œ
      - name: Upload dist to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "ZzicGo_fe/dist/*"
          target: "/home/ubuntu/frontend/dist"

      # 6. Nginx ìž¬ì‹œìž‘
      - name: Restart Nginx
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "sudo systemctl restart nginx"
