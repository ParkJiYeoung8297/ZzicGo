name: Backend Deploy (Reusable)

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string

jobs:
  # âœ… 1ï¸âƒ£ Build Job
  build:
    name: Build Spring Boot
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for gradlew
        run: |
          cd ZzicGo_be
          chmod +x gradlew

      - name: Build with Gradle
        run: |
          cd ZzicGo_be
          ./gradlew clean build -x test

      # âœ… ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ë°°í¬ jobì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZzicGo-be-jar
          path: ZzicGo_be/build/libs/*.jar

  # âœ… 2ï¸âƒ£ Deploy Job
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build  # âœ… build jobì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ZzicGo-be-jar
          path: .

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          LOG_FILE="/home/ec2-user/app/deploy.log"
          APP_DIR="/home/ec2-user/app"
          SERVICE_NAME="zzicgo.service"

          echo "ðŸ“¦ Deploying application..." > deploy.log

          # âœ… ìµœì‹  JAR íŒŒì¼ ì´ë¦„ ì°¾ê¸°
          JAR_FILE=$(ls *.jar | sort | tail -n 1)

          # âœ… EC2ë¡œ ì „ì†¡
          scp -i $EC2_SSH_KEY -o StrictHostKeyChecking=no "$JAR_FILE" $EC2_USER@$EC2_HOST:$APP_DIR/

          # âœ… ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          ssh -i $EC2_SSH_KEY -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "
            echo 'Stopping $SERVICE_NAME...' >> $LOG_FILE
            sudo systemctl stop $SERVICE_NAME
            sleep 3
            echo 'Starting $SERVICE_NAME...' >> $LOG_FILE
            sudo systemctl start $SERVICE_NAME
            echo 'âœ… Deployment finished at $(date '+%Y-%m-%d %H:%M:%S')' >> $LOG_FILE
          "

          echo "âœ… EC2 deployment finished successfully."
